version: 2.1

setup: true

jobs:
  setup:
    docker:
      - image: cimg/python:3.12.9-node
    steps:
      - checkout
      - run:
          name: "Install Bazelisk"
          command: "sudo npm install -g @bazel/bazelisk"
      - run:
          name: "Generate config"
          command: |
            # Get all Python test targets, excluding requirements_test
            TEST_TARGETS=$(bazelisk query 'kind("py_test", //...)' | grep -vE ":requirements_test")

            # Start generating the new config
            cat > generated_config.yml << EOL
            version: 2.1

            jobs:
            EOL

            # Add a job for each test target
            for target in $TEST_TARGETS; do
              # Create a sanitized job name from the target
              job_name=$(echo "$target" | tr '/:' '__' | tr -d '()' | sed 's/^_//g')
              
              cat >> generated_config.yml << EOL
              ${job_name}:
                docker:
                  - image: cimg/python:3.12.9-node
                steps:
                  - checkout
                  - run:
                      name: "Install Bazelisk"
                      command: "sudo npm install -g @bazel/bazelisk"
                  - run:
                      name: "Run Bazel test: ${target}"
                      command: "bazelisk test ${target}"
            EOL
            done

            # Add workflow configuration
            cat >> generated_config.yml << EOL

            workflows:
              test-workflow:
                jobs:
            EOL

            # Add all jobs to workflow
            for target in $TEST_TARGETS; do
              job_name=$(echo "$target" | tr '/:' '__' | tr -d '()' | sed 's/^_//g')
              echo "      - ${job_name}" >> generated_config.yml
            done

            # Display the generated config for debugging
            cat generated_config.yml
      - run:
          name: "Continue with dynamic config"
          command: |
            circleci config process generated_config.yml > processed_config.yml
            circleci continue --config processed_config.yml

workflows:
  setup-workflow:
    jobs:
      - setup
